<!DOCTYPE html><html class="theme-next pisces use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet"><link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|consolas:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet"><link href="/css/main.css?v=5.1.4" rel="stylesheet"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/dog-32x32.ico?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/dog.ico?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="总结,面试,"><meta name="description" content="1. github1.1. 文档知识 后端架构师技术图谱(architect-awesome)    Java核心知识库(JCSprout)    java面试指南(JavaGuide)    Java开源生鲜电商平台      1.2. 开源项目1.2.1. Java垂直爬虫框架(Web Magic)Java垂直爬虫框架(Web Magic)   1.2.2. Spring Cloud + Vu"><meta name="keywords" content="总结,面试"><meta property="og:type" content="article"><meta property="og:title" content="java优秀的开源项目和博客"><meta property="og:url" content="https://www.ddebug.cn/java-open-program-learning.html"><meta property="og:site_name" content="技术驿站"><meta property="og:description" content="1. github1.1. 文档知识 后端架构师技术图谱(architect-awesome)    Java核心知识库(JCSprout)    java面试指南(JavaGuide)    Java开源生鲜电商平台      1.2. 开源项目1.2.1. Java垂直爬虫框架(Web Magic)Java垂直爬虫框架(Web Magic)   1.2.2. Spring Cloud + Vu"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://www.ddebug.cn/1"><meta property="og:updated_time" content="2018-11-06T09:59:20.881Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="java优秀的开源项目和博客"><meta name="twitter:description" content="1. github1.1. 文档知识 后端架构师技术图谱(architect-awesome)    Java核心知识库(JCSprout)    java面试指南(JavaGuide)    Java开源生鲜电商平台      1.2. 开源项目1.2.1. Java垂直爬虫框架(Web Magic)Java垂直爬虫框架(Web Magic)   1.2.2. Spring Cloud + Vu"><meta name="twitter:image" content="https://www.ddebug.cn/1"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://www.ddebug.cn/java-open-program-learning.html"><title>java优秀的开源项目和博客 | 技术驿站</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?fd5e5f7ea9d2773791e4c73706b32208";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">技术驿站</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">在这里歇会吧</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://www.ddebug.cn/java-open-program-learning.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="咸鱼翻面"><meta itemprop="description" content=""><meta itemprop="image" content="/uploads/avatar.jpeg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="技术驿站"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">java优秀的开源项目和博客</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-25T14:28:21+08:00">2018-07-25</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/总结大全/" itemprop="url" rel="index"><span itemprop="name">总结大全</span></a></span></span> <span class="post-comments-count"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span><a href="/java-open-program-learning.html#SOHUCS" itemprop="discussionUrl"><span id="changyan_count_unit" class="post-comments-count hc-comment-count" data-xid="java-open-program-learning.html" itemprop="commentsCount"></span></a> <span id="/java-open-program-learning.html" class="leancloud_visitors" data-flag-title="java优秀的开源项目和博客"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数&#58;</span><span class="leancloud-visitors-count"></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">4,646</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">21</span></div></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="github">1. github</h1><h2 id="文档知识">1.1. 文档知识</h2><ol><li><p><a href="https://github.com/xingshaocheng/architect-awesome" target="_blank" rel="noopener">后端架构师技术图谱(architect-awesome)</a></p></li><li><p><a href="https://github.com/crossoverJie/JCSprout" target="_blank" rel="noopener">Java核心知识库(JCSprout)</a></p></li><li><p><a href="https://github.com/Snailclimb/JavaGuide" target="_blank" rel="noopener">java面试指南(JavaGuide)</a></p></li><li><p><a href="http://www.cnblogs.com/jurendage" target="_blank" rel="noopener">Java开源生鲜电商平台</a></p></li></ol><h2 id="开源项目">1.2. 开源项目</h2><h3 id="Java垂直爬虫框架-Web-Magic">1.2.1. Java垂直爬虫框架(Web Magic)</h3><p><a href="https://github.com/code4craft/webmagic/blob/master/README-zh.md" target="_blank" rel="noopener">Java垂直爬虫框架(Web Magic)</a></p><h3 id="Spring-Cloud-Vue-oAuth2-0商城-paascloud-master">1.2.2. Spring Cloud + Vue + oAuth2.0商城(paascloud-master)</h3><p><a href="https://github.com/paascloud/paascloud-master" target="_blank" rel="noopener">Spring Cloud + Vue + oAuth2.0商城(paascloud-master)</a></p><h3 id="基于可靠消息最终一致性分布式事务框架-myth">1.2.3. 基于可靠消息最终一致性分布式事务框架(myth)</h3><p><a href="https://github.com/yu199195/myth" target="_blank" rel="noopener">基于可靠消息最终一致性分布式事务框架(myth)</a></p><h3 id="高性能异步分布式事务TCC框架">1.2.4. 高性能异步分布式事务TCC框架</h3><p><a href="https://github.com/yu199195/hmily" target="_blank" rel="noopener">高性能异步分布式事务TCC框架（try/confirm/cancel）</a></p><h1 id="开源项目讲解">2. 开源项目讲解</h1><h2 id="Hmily项目demo流程">2.1. Hmily项目demo流程</h2><ol><li><p>aop</p><blockquote><p>根据添加的注解进行aop处理</p></blockquote></li><li><p>rpc框架特性</p><blockquote><p>在调用远程服务的接口前，获取所调用的方法签名</p></blockquote></li><li><p>rpc框架参数传递</p><blockquote><p>通过ThreadLocal保存事务上下文信息，进行参数传递</p></blockquote></li><li><p>事务日志，到底存储了什么东西？怎么存储的，怎么序列化的？</p><blockquote><p>采用<code>disruptor</code>进行事务日志异步读写，与rpc框架性能毫无差别</p></blockquote></li><li><p>定时事务补偿</p><blockquote><p>使用jdk的<code>ScheduledExecutorService.scheduleWithFixedDelay()</code>，主要作用将定时任务和线程池功能结合使用。<br>参考：<a href="https://www.cnblogs.com/huhx/p/baseusejavaScheduledExecutorService.html" target="_blank" rel="noopener">Thread之ScheduledExecutorService的使用</a><br>解决集群下重复执行问题，可以使用<a href="https://blog.csdn.net/quwenzhe/article/details/78865875" target="_blank" rel="noopener">redis分布式锁</a>解决，redis的命令<code>setnx</code>实现：当网redis中存入一个值时，会先判断该值对应的key是否存在，如果存在则返回0，如果不存在，则将该值存入redis并返回1。<br>根据上面的特性，我们在执行任务的程序中，每次都调用<code>setIfAbsent(该方法时setnx命令的实现)</code>方法，来模拟是否获取到锁，如果返回true，则说明key值不存在，表示获取到锁；如果返回false，则说明key值已存在，已经有程序使用这个key了，从而实现类似加锁的功能。</p></blockquote></li><li><p>高效并发</p><blockquote><p>单机 <strong>2000</strong> 并发，可以通过<a href="http://www.cnblogs.com/yangxia-test/p/3964881.html" target="_blank" rel="noopener">jmeter压测</a><br>因为目前是异步的存储日志到mysql，会有限制，使用<code>mongo</code>集群，很快</p></blockquote></li><li><p>TCC缺点</p><blockquote><p>代码量多，try、confirm、cancel三个方法，使用者需要知道confirm、cancel方法的正确书写，使用场景有限。<br>事务日志需要记录：推荐使用高效的存储，推荐使用mongo集群，kroy序列化</p></blockquote></li><li><p>TCC优点</p><blockquote><p>天然支持集群，不依赖于事务；<br>依赖事务日志，最终一致性</p></blockquote></li></ol><h3 id="使用技术">2.1.1. 使用技术</h3><h4 id="mysql乐观锁">2.1.1.1. mysql乐观锁</h4><p>目的：解决高并发。</p><p>参考：<a href="https://www.cnblogs.com/jurendage/p/9232173.html" target="_blank" rel="noopener">APP大规模高并发请求和抢购的架构与解决方案</a></p><p>在<strong>定时事务补偿</strong>补偿中，对于事务异常记录到数据库中的事务进行补偿重试操作，为避免高并发，采用<code>mysql乐观锁</code>机制，采用版本号的形式实现，事务的重试次数即为版本号。</p><blockquote><p>乐观锁，是相对于<strong>悲观锁</strong>采用更为宽松的加锁机制，大都是采用带版本号（Version）更新。实现就是，这个数据所有请求都有资格去修改，但会获得一个该数据的版本号，只有版本号符合的才能重试。</p></blockquote><blockquote><p>悲观锁，也就是在修改数据的时候，采用锁定状态，排斥外部请求的修改。遇到加锁的状态，就必须等待。<br>虽然上述的方案的确解决了线程安全的问题，但是，别忘记，我们的场景是“高并发”。也就是说，会很多这样的修改请求，每个请求都需要等待“锁”，某些线程可能永远都没有机会抢到这个“锁”，这种请求就会死在那里。同时，这种请求会很多，瞬间增大系统的平均响应时间，结果是可用连接数被耗尽，系统陷入异常。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(<span class="keyword">final</span> TccTransaction tccTransaction)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Integer currentVersion = tccTransaction.getVersion();</span><br><span class="line">    tccTransaction.setLastTime(<span class="keyword">new</span> Date());</span><br><span class="line">    tccTransaction.setVersion(tccTransaction.getVersion() + <span class="number">1</span>);</span><br><span class="line">    String sql = <span class="string">"update "</span> + tableName</span><br><span class="line">            + <span class="string">" set last_time = ?,version =?,retried_count =?,invocation=?,status=? ,pattern=? where trans_id = ? and version=? "</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] serialize = serializer.serialize(tccTransaction.getParticipants());</span><br><span class="line">        <span class="keyword">return</span> executeUpdate(sql, tccTransaction.getLastTime(),</span><br><span class="line">                tccTransaction.getVersion(), tccTransaction.getRetriedCount(), serialize,</span><br><span class="line">                tccTransaction.getStatus(), tccTransaction.getPattern(),</span><br><span class="line">                tccTransaction.getTransId(), currentVersion);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (TccException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> FAIL_ROWS;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ScheduledExecutorService">2.1.1.2. ScheduledExecutorService</h4><p>参考博客：<a href="http://moon-walker.iteye.com/blog/2407533" target="_blank" rel="noopener">a定时任务之ScheduledThreadPoolExecutor</a></p><ol><li><p>extends <a href="http://moon-walker.iteye.com/blog/2406788" target="_blank" rel="noopener">ThreadPoolExecutor</a>，说明本质也是一个线程池。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScheduledThreadPoolExecutor</span>  <span class="keyword">extends</span> <span class="title">ThreadPoolExecutor</span>  </span></span><br><span class="line"><span class="class">                <span class="keyword">implements</span> <span class="title">ScheduledExecutorService</span> </span>&#123;  </span><br><span class="line"><span class="comment">//省略实现代码  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>实现<code>ScheduledExecutorService</code>接口，自定义个性方法，实现<strong>延迟任务和周期性任务</strong>的核心方法。</p></li></ol><blockquote><p>下面四个方法都是提交任务方法，相当于<code>ThreadPoolExecutor</code>的execute、submit方法，并且都由返回值，类型都是<code>ScheduledFuture</code>，相当于普通线程池的<code>Future</code>，可以用于控制任务生命周期。</p></blockquote><blockquote><p>第1、2个是<strong>延迟任务</strong>，即延迟固定period时间后，执行任务。<br>第3、4个是<strong>周期性任务</strong>，<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 延迟任务 执行方法，参数为Runnable类型对象  </span></span><br><span class="line"><span class="keyword">public</span> ScheduledFuture&lt;?&gt; schedule(Runnable command,  </span><br><span class="line">                                    <span class="keyword">long</span> delay, TimeUnit unit);  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 延迟任务 执行方法，参数为Callable类型对象  </span></span><br><span class="line"><span class="keyword">public</span> &lt;V&gt; <span class="function">ScheduledFuture&lt;V&gt; <span class="title">schedule</span><span class="params">(Callable&lt;V&gt; callable,  </span></span></span><br><span class="line"><span class="function"><span class="params">                                        <span class="keyword">long</span> delay, TimeUnit unit)</span></span>;  </span><br><span class="line"><span class="comment">// 3. 固定频率 执行方法，任务时间到后就立即执行</span></span><br><span class="line"><span class="comment">// 等待周期分两种情况：如果程序的执行时间大于间隔时间，等待周期为执行时间；</span></span><br><span class="line"><span class="comment">// 如果程序的执行时间小于间隔时间，等待周期为间隔时间</span></span><br><span class="line"><span class="keyword">public</span> ScheduledFuture&lt;?&gt; scheduleAtFixedRate(Runnable command,  </span><br><span class="line">                                                <span class="keyword">long</span> initialDelay,  </span><br><span class="line">                                                <span class="keyword">long</span> period,  </span><br><span class="line">                                                TimeUnit unit);  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 固定延迟周期 执行方法，上次执行完成后（不管执行任务需要花多长时间）固定等待延迟时间后 再执行  </span></span><br><span class="line"><span class="keyword">public</span> ScheduledFuture&lt;?&gt; scheduleWithFixedDelay(Runnable command,  </span><br><span class="line">                                                    <span class="keyword">long</span> initialDelay,  </span><br><span class="line">                                                    <span class="keyword">long</span> delay,  </span><br><span class="line">                                                    TimeUnit unit);</span><br></pre></td></tr></table></figure><p></p></blockquote><ol start="3"><li>新建线程池的任务队列是<code>ScheduledThreadPoolExecutor</code>的静态内部类<code>DelayedWorkQueue</code>。<blockquote><p>该队列主要是维护了一个由<a href="https://www.cnblogs.com/skywang12345/p/3610390.html" target="_blank" rel="noopener">二叉堆算法(最小堆)</a>实现的数组，简单理解就是在调用add方法插入队列时，采用二叉堆算法保证第一个元素是最小值，这里其实就是<strong>Delay时间</strong>最小的值。</p></blockquote></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ScheduledService</span><span class="params">(<span class="keyword">final</span> TccConfig tccConfig, <span class="keyword">final</span> CoordinatorRepository coordinatorRepository)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.tccConfig = tccConfig;</span><br><span class="line">        <span class="keyword">this</span>.coordinatorRepository = coordinatorRepository;</span><br><span class="line">        <span class="comment">// 内部默认实现了队列</span></span><br><span class="line">        <span class="keyword">this</span>.scheduledExecutorService = <span class="keyword">new</span> ScheduledThreadPoolExecutor(<span class="number">1</span>, HmilyThreadFactory.create(<span class="string">"tccRollBackService"</span>, <span class="keyword">true</span>));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h4 id="切面-AOP">2.1.1.3. 切面-AOP</h4><ol><li>理解了aop，就理解了tcc，就理解了分布式事务的实现。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="meta">@Tcc</span>(confirmMethod = <span class="string">"confirmOrderStatus"</span>, cancelMethod = <span class="string">"cancelOrderStatus"</span>)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">makePayment</span><span class="params">(Order order)</span> </span>&#123;</span><br><span class="line">       order.setStatus(OrderStatusEnum.PAYING.getCode());</span><br><span class="line">       <span class="comment">// 本地事务</span></span><br><span class="line">       orderMapper.update(order);</span><br><span class="line">       <span class="comment">// 扣除用户余额</span></span><br><span class="line">       AccountDTO accountDTO = <span class="keyword">new</span> AccountDTO();</span><br><span class="line">       accountDTO.setAmount(order.getTotalAmount());</span><br><span class="line">       accountDTO.setUserId(order.getUserId());</span><br><span class="line">       LOGGER.debug(<span class="string">"===========执行springcloud扣减资金接口=========="</span>);</span><br><span class="line">       <span class="comment">// 远端服务</span></span><br><span class="line">       accountClient.payment(accountDTO);</span><br><span class="line">       <span class="comment">//进入扣减库存操作</span></span><br><span class="line">       InventoryDTO inventoryDTO = <span class="keyword">new</span> InventoryDTO();</span><br><span class="line">       inventoryDTO.setCount(order.getCount());</span><br><span class="line">       inventoryDTO.setProductId(order.getProductId());</span><br><span class="line">       <span class="comment">// 远端服务</span></span><br><span class="line">       inventoryClient.decrease(inventoryDTO);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><ol start="2"><li><p>实现springcloud的切面类实现了Spirng的<code>Ordered</code>接口，并重写了getOrder方法，返回<code>Ordered.HIGHEST_PRECEDENCE</code>，所以他是优先级最高的切面。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringCloudHmilyTransactionAspect</span> <span class="keyword">extends</span> <span class="title">AbstractTccTransactionAspect</span> <span class="keyword">implements</span> <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SpringCloudHmilyTransactionAspect</span><span class="params">(<span class="keyword">final</span> SpringCloudHmilyTransactionInterceptor springCloudHmilyTransactionInterceptor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setTccTransactionInterceptor(springCloudHmilyTransactionInterceptor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Ordered.HIGHEST_PRECEDENCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>我们在<code>下订单</code>时会调用远端rpc服务，springcloud使用<code>@FeignClient</code>，并在接口上加了注解<code>@Tcc</code>。</p><blockquote><p>Spring AOP的特性，接口上加注解，无法进入切面，所以在这里，要采用rpc框架的某些特性来帮助我们获取到<code>@Tcc</code>注解信息。</p></blockquote></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(value = <span class="string">"account-service"</span>, configuration = MyConfiguration.class)</span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"all"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户账户付款</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> accountDO 实体类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/account-service/account/payment"</span>)</span><br><span class="line">    <span class="meta">@Tcc</span></span><br><span class="line">    <span class="function">Boolean <span class="title">payment</span><span class="params">(@RequestBody AccountDTO accountDO)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>承接上一步，当调用<code>SpringCloud</code>的RPC服务<code>accountClient.payment()</code>，会进入<code>HmilyFeignHandler</code>。<blockquote><p>通过@FeignClient的自定义配置<code>MyConfiguration.java</code>;<br>在这里我们获取了之前设置到本地ThreadLocal里的事务上下文，然后进行SpringCloud的rpc传参数。<br>保存方法的所有的信息，方法签名、接口等。</p></blockquote></li></ol><h3 id="tcc库作用">2.1.2. tcc库作用</h3><p>存储做分布式事务时的日志信息。</p><ol><li>如果是正常执行，日志信息会删除；</li><li><p><code>订单</code>、<code>库存</code>、<code>账户</code>三个不同的库，下订单时，属于分布式事务，如果有一处异常，比如库存异常（服务断掉），已经持久化的订单、账户就会回滚，保持事务高度一致性。</p></li><li><p>服务超时时，通过<strong>本地补偿</strong>，</p></li></ol><ul><li>applicationContext.xml<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.hmily.tcc.*"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span> <span class="attr">expose-proxy</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"hmilyTransactionBootstrap"</span> <span class="attr">class</span>=<span class="string">"com.hmily.tcc.core.bootstrap.HmilyTransactionBootstrap"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"serializer"</span> <span class="attr">value</span>=<span class="string">"kryo"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"recoverDelayTime"</span> <span class="attr">value</span>=<span class="string">"120"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"retryMax"</span> <span class="attr">value</span>=<span class="string">"30"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"scheduledDelay"</span> <span class="attr">value</span>=<span class="string">"120"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"scheduledThreadMax"</span> <span class="attr">value</span>=<span class="string">"4"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"repositorySupport"</span> <span class="attr">value</span>=<span class="string">"db"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"tccDbConfig"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.hmily.tcc.common.config.TccDbConfig"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span></span></span><br><span class="line"><span class="tag">                          <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/tcc?useUnicode=true&amp;amp;characterEncoding=utf8"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="执行confirm、cancel方法失败时">2.1.3. 执行confirm、cancel方法失败时</h3><p>框架初始化时，会初始化一个线程池，任务调度，根据你的配置多少时间轮询一次。</p><ol><li>如果你的日志没有删除，服务分布式事务执行失败，进行各种情况的判断；</li><li>如果try未执行完成，那么就不进行补偿，直接删除事务日志 （防止在try阶段的各种异常情况）</li><li>如果超过了最大执行次数，不再进行重试</li><li></li></ol><h3 id="Myth项目demo流程">2.1.4. Myth项目demo流程</h3><blockquote><p><code>MythMqReceiveServiceImpl.java</code>: ReentrantLock</p></blockquote><ul><li>订单支付分布式事务流程</li></ul><ol><li><p>service层 <code>PaymentServiceImpl.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Myth</span>(destination = <span class="string">""</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">makePayment</span><span class="params">(Order order)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 扣除余额</span></span><br><span class="line">  <span class="comment">// 扣减库存</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>因为上面service有 <code>@Myth</code> 注解，该注解使用了 <code>Aop</code> 切面拦截该注解 <code>AbstractMythTransactionAspect.java</code><br>spirng aop AspectJ参考：<a href="https://blog.csdn.net/zhengchao1991/article/details/53391244" target="_blank" rel="noopener">Spring 之AOP AspectJ切入点语法详解</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Pointcut</span>(<span class="string">"@annotation(com.github.myth.annotation.Myth)"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mythTransactionInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * this is around in &#123;<span class="doctag">@linkplain</span> com.github.myth.annotation.Myth &#125;.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> proceedingJoinPoint proceedingJoinPoint</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Object</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Throwable  Throwable</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Around</span>(<span class="string">"mythTransactionInterceptor()"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">interceptMythAnnotationMethod</span><span class="params">(<span class="keyword">final</span> ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mythTransactionInterceptor.interceptor(proceedingJoinPoint);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>Aop</code>拦截器对事务进行处理，判断事务角色是否是发起者、本地执行或者提供者<code></code></p><blockquote><p>此处事务已经发起，返回<code>StartMythTransactionHandler.java</code><br><img src="1" alt=""></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MythTransactionFactoryServiceImpl</span> <span class="keyword">implements</span> <span class="title">MythTransactionFactoryService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MythTransactionEngine mythTransactionEngine;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MythTransactionFactoryServiceImpl</span><span class="params">(<span class="keyword">final</span> MythTransactionEngine mythTransactionEngine)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mythTransactionEngine = mythTransactionEngine;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断事务类型并返回相应事务处理类</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Class <span class="title">factoryOf</span><span class="params">(<span class="keyword">final</span> MythTransactionContext context)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="comment">//如果事务还没开启或者 myth事务上下文是空， 那么应该进入发起调用</span></span><br><span class="line">        <span class="keyword">if</span> (!mythTransactionEngine.isBegin() &amp;&amp; Objects.isNull(context)) &#123;</span><br><span class="line">            <span class="keyword">return</span> StartMythTransactionHandler.class;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (context.getRole() == MythRoleEnum.LOCAL.getCode()) &#123;</span><br><span class="line">                <span class="keyword">return</span> LocalMythTransactionHandler.class;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ActorMythTransactionHandler.class;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MythTransactionAspectServiceImpl</span> <span class="keyword">implements</span> <span class="title">MythTransactionAspectService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MythTransactionFactoryService mythTransactionFactoryService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MythTransactionAspectServiceImpl</span><span class="params">(<span class="keyword">final</span> MythTransactionFactoryService mythTransactionFactoryService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mythTransactionFactoryService = mythTransactionFactoryService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(<span class="keyword">final</span> MythTransactionContext mythTransactionContext, <span class="keyword">final</span> ProceedingJoinPoint point)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="comment">// 返回相应事务</span></span><br><span class="line">        <span class="keyword">final</span> Class clazz = mythTransactionFactoryService.factoryOf(mythTransactionContext);</span><br><span class="line">        <span class="keyword">final</span> MythTransactionHandler mythTransactionHandler = (MythTransactionHandler) SpringBeanUtils.getInstance().getBean(clazz);</span><br><span class="line">        <span class="comment">// 处理相应事务（该流程下事务已经开始，进入StartMythTransactionHandler.java）</span></span><br><span class="line">        <span class="keyword">return</span> mythTransactionHandler.handler(point, mythTransactionContext);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>处理事务：<code>StartMythTransactionHandler.handler()</code></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">handler</span><span class="params">(<span class="keyword">final</span> ProceedingJoinPoint point, <span class="keyword">final</span> MythTransactionContext mythTransactionContext)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 异步保存事务</span></span><br><span class="line">        mythTransactionEngine.begin(point);</span><br><span class="line">        <span class="keyword">final</span> Object proceed = point.proceed();</span><br><span class="line">        mythTransactionEngine.updateStatus(MythStatusEnum.COMMIT.getCode());</span><br><span class="line">        <span class="keyword">return</span> proceed;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">        <span class="comment">//更新失败的日志信息</span></span><br><span class="line">        mythTransactionEngine.failTransaction(throwable.getMessage());</span><br><span class="line">        <span class="keyword">throw</span> throwable;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//发送消息</span></span><br><span class="line">        mythTransactionEngine.sendMessage();</span><br><span class="line">        mythTransactionEngine.cleanThreadLocal();</span><br><span class="line">        TransactionContextLocal.getInstance().remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="订单支付流程异常处理">2.1.4.1. 订单支付流程异常处理</h4><ul><li>下订单业务逻辑<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Myth</span>(destination = <span class="string">""</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">makePayment</span><span class="params">(Order order)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//检查数据 这里只是demo 只是demo 只是demo</span></span><br><span class="line">        <span class="comment">// 省略...</span></span><br><span class="line">        <span class="comment">// 1. 本地事务：更新订单</span></span><br><span class="line">        order.setStatus(OrderStatusEnum.PAY_SUCCESS.getCode());</span><br><span class="line">        orderMapper.update(order);</span><br><span class="line">        <span class="comment">// 2. 远程事务：扣除用户余额</span></span><br><span class="line">        AccountDTO accountDTO = <span class="keyword">new</span> AccountDTO();</span><br><span class="line">        accountDTO.setAmount(order.getTotalAmount());</span><br><span class="line">        accountDTO.setUserId(order.getUserId());</span><br><span class="line">        accountClient.payment(accountDTO);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 远程事务：进入扣减库存操作</span></span><br><span class="line">        InventoryDTO inventoryDTO = <span class="keyword">new</span> InventoryDTO();</span><br><span class="line">        inventoryDTO.setCount(order.getCount());</span><br><span class="line">        inventoryDTO.setProductId(order.getProductId());</span><br><span class="line">        inventoryClient.decrease(inventoryDTO);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li></ul><h5 id="停掉Invertory库存服务">2.1.4.1.1. 停掉Invertory库存服务</h5><p>承接上一节内容，此时如果在<code>第3步</code>扣库存时停掉<code>invertory</code>微服务，会发现之前执行的<strong>订单更新</strong>、远程服务的<strong>扣除余额</strong>操作都已经正常完成；<br>而库存并没有减掉，再次重新启动<code>invertory</code>服务，发现会自动执行未完成事务，完成扣库存操作。</p><ol><li>重启<code>invertory</code>服务时，会经过<code>SpringCloudMythTransactionInterceptor.interceptor()</code>执行事务补偿。</li></ol><h5 id="停掉Order服务">2.1.4.1.2. 停掉Order服务</h5><p>如果上面再<code>第2步</code>停掉<code>order</code>服务，<code>order</code>服务会执行完该业务方法，即完成<code>2、3步</code>。不会造成分布式事务问题。</p><h5 id="停掉消息服务RabbitMQ">2.1.4.1.3. 停掉消息服务RabbitMQ</h5><ul><li><figure class="highlight plain"><figcaption><span>通过线程池调动一直重试恢复</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">```java</span><br><span class="line">    @Override</span><br><span class="line">    public void initialization(final MythConfig mythConfig) &#123;</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(new Thread(() -&gt; LOGGER.error(&quot;myth have error!&quot;)));</span><br><span class="line">        try &#123;</span><br><span class="line">            loadSpiSupport(mythConfig);</span><br><span class="line">            // 启动disruptor</span><br><span class="line">            publisher.start(mythConfig.getBufferSize());</span><br><span class="line">            coordinatorService.start(mythConfig);</span><br><span class="line">            // (事务发起者)如果需要自动恢复 开启线程 调度线程池，进行恢复</span><br><span class="line">            if (mythConfig.getNeedRecover()) &#123;</span><br><span class="line">                scheduledService.scheduledAutoRecover(mythConfig);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception ex) &#123;</span><br><span class="line">            LogUtil.error(LOGGER, &quot;Myth init fail:&#123;&#125;&quot;, ex::getMessage);</span><br><span class="line">            //非正常关闭</span><br><span class="line">            System.exit(1);</span><br><span class="line">        &#125;</span><br><span class="line">        LogUtil.info(LOGGER, () -&gt; &quot;Myth init success&quot;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li></ul><h4 id="Disruptor-无锁并行计算框架">2.1.4.2. Disruptor(无锁并行计算框架)</h4><p>在无锁的情况下实现网络的Queue并发操作，高性能的异步事件驱动型的处理框架，或者可以认为是最快的消息框架（轻量的JMS），也可以认为是一个观察者模式的实现，或者事件监听模式的实现。</p><p>典型的<strong>生产者-消费者</strong>模式，disruptor使用RingBuffer存放数据，sequence管理生产和消费的位置（long类型，递增），生产者要生产数据的时候首先向生产者请求一个sequence，然后在sequence的位置放置数据。</p><p>参考博客：<a href="https://www.cnblogs.com/sigm/p/6251910.html" target="_blank" rel="noopener">架构师养成记–15.Disruptor并发框架</a></p><ul><li>项目使用流程总结<blockquote><p><code>MythTransactionBootStrap.java</code>启动类中初始化启动了<code>Disruptor</code>，当然还启动了其他配置。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(<span class="keyword">final</span> MythConfig mythConfig)</span> </span>&#123;</span><br><span class="line">    mythInitService.initialization(mythConfig);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MythInitServiceImpl.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialization</span><span class="params">(<span class="keyword">final</span> MythConfig mythConfig)</span> </span>&#123;</span><br><span class="line">    Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(() -&gt; LOGGER.error(<span class="string">"myth have error!"</span>)));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        loadSpiSupport(mythConfig);</span><br><span class="line">        <span class="comment">// 启动disruptor</span></span><br><span class="line">        <span class="comment">// bufferSize，RingBuffer大小，必须是2的N次方</span></span><br><span class="line">        publisher.start(mythConfig.getBufferSize());</span><br><span class="line">        coordinatorService.start(mythConfig);</span><br><span class="line">        <span class="comment">//(事务发起者)如果需要自动恢复 开启线程 调度线程池，进行恢复</span></span><br><span class="line">        <span class="keyword">if</span> (mythConfig.getNeedRecover()) &#123;</span><br><span class="line">            scheduledService.scheduledAutoRecover(mythConfig);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        LogUtil.error(LOGGER, <span class="string">"Myth init fail:&#123;&#125;"</span>, ex::getMessage);</span><br><span class="line">        <span class="comment">//非正常关闭</span></span><br><span class="line">        System.exit(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    LogUtil.info(LOGGER, () -&gt; <span class="string">"Myth init success"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li><p>建立<code>Event</code>类（数据对象）</p><blockquote><p>事务对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MythTransactionEvent</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MythTransaction mythTransaction;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> type;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * help gc.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mythTransaction = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote></li><li><p>建立一个生产数据的工厂类，<code>EventFactory</code>，用于生产数据</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MythTransactionEventFactory</span> <span class="keyword">implements</span> <span class="title">EventFactory</span>&lt;<span class="title">MythTransactionEvent</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MythTransactionEvent <span class="title">newInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MythTransactionEvent();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>监听事件类（处理Event数据）</p><blockquote><p>监听策略</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BlockingWaitStrategy 是最低效的策略，但其对CPU的消耗最小并且在各种不同部署环境中能提供更加一致的性能表现</span></span><br><span class="line">WaitStrategy BLOCKING_WAIT = <span class="keyword">new</span> BlockingWaitStrategy();</span><br><span class="line"></span><br><span class="line"><span class="comment">// SleepingWaitStrategy 的性能表现跟BlockingWaitStrategy差不多，对CPU的消耗也类似，但其对生产者线程的影响最小，适合用于异步日志类似的场景</span></span><br><span class="line">WaitStrategy SLEEPING_WAIT = <span class="keyword">new</span> SleepingWaitStrategy();</span><br><span class="line"></span><br><span class="line"><span class="comment">// YieldingWaitStrategy 的性能是最好的，适合用于低延迟的系统。在要求极高性能且事件处理线数小于CPU逻辑核心数的场景中，推荐使用此策略；例如，CPU开启超线程的特性</span></span><br><span class="line">WaitStrategy YIELDING_WAIT = <span class="keyword">new</span> YieldingWaitStrategy();</span><br></pre></td></tr></table></figure></blockquote></li><li><p>实例化Disruptor，配置参数，绑定事件</p><blockquote><p><code>MythTransactionEventPublisher.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> bufferSize)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建 disruptor</span></span><br><span class="line">    <span class="comment">// 使用 BlockingWatiStrategy 策略</span></span><br><span class="line">    <span class="comment">// ProducerType: MULTI(多个生产者), SINGLE(单个生产者)</span></span><br><span class="line">    disruptor = <span class="keyword">new</span> Disruptor&lt;&gt;(<span class="keyword">new</span> MythTransactionEventFactory(), bufferSize, r -&gt; &#123;</span><br><span class="line">        AtomicInteger index = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Thread(<span class="keyword">null</span>, r, <span class="string">"disruptor-thread-"</span> + index.getAndIncrement());</span><br><span class="line">    &#125;, ProducerType.MULTI, <span class="keyword">new</span> BlockingWaitStrategy());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消费者缓存池构建</span></span><br><span class="line">    <span class="keyword">final</span> Executor executor = <span class="keyword">new</span> ThreadPoolExecutor(MAX_THREAD, MAX_THREAD, <span class="number">0</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">            <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;(),</span><br><span class="line">            MythTransactionThreadFactory.create(<span class="string">"myth-log-disruptor"</span>, <span class="keyword">false</span>),</span><br><span class="line">            <span class="keyword">new</span> ThreadPoolExecutor.AbortPolicy());</span><br><span class="line"></span><br><span class="line">    MythTransactionEventHandler[] consumers = <span class="keyword">new</span> MythTransactionEventHandler[MAX_THREAD];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MAX_THREAD; i++) &#123;</span><br><span class="line">        consumers[i] = <span class="keyword">new</span> MythTransactionEventHandler(coordinatorService, executor);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 连接消费者的方法</span></span><br><span class="line">    disruptor.handleEventsWithWorkerPool(consumers);</span><br><span class="line">    disruptor.setDefaultExceptionHandler(<span class="keyword">new</span> IgnoreExceptionHandler());</span><br><span class="line">    <span class="comment">// 启动</span></span><br><span class="line">    disruptor.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote></li><li><p>事件发布</p><blockquote><p>建存放数据的核心 RingBuffer，生产的数据放入 RungBuffer，本项目中就是各种类型的事务。参考上面的<strong>订单支付分布式事务流程</strong>的第<br>4步，处理<code>Start</code>类型事务。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// StartMythTransactionHandler.java  </span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">handler</span><span class="params">(<span class="keyword">final</span> ProceedingJoinPoint point, <span class="keyword">final</span> MythTransactionContext mythTransactionContext)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 此处发布了（生产者数据）事务</span></span><br><span class="line">        mythTransactionEngine.begin(point);</span><br><span class="line">        <span class="keyword">final</span> Object proceed = point.proceed();</span><br><span class="line">        mythTransactionEngine.updateStatus(MythStatusEnum.COMMIT.getCode());</span><br><span class="line">        <span class="keyword">return</span> proceed;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">        <span class="comment">//更新失败的日志信息</span></span><br><span class="line">        mythTransactionEngine.failTransaction(throwable.getMessage());</span><br><span class="line">        <span class="keyword">throw</span> throwable;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//发送消息</span></span><br><span class="line">        mythTransactionEngine.sendMessage();</span><br><span class="line">        mythTransactionEngine.cleanThreadLocal();</span><br><span class="line">        TransactionContextLocal.getInstance().remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MythTransactionEngine.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">(<span class="keyword">final</span> ProceedingJoinPoint point)</span> </span>&#123;</span><br><span class="line">    LogUtil.debug(LOGGER, () -&gt; <span class="string">"开始执行Myth分布式事务！start"</span>);</span><br><span class="line">    MythTransaction mythTransaction = buildMythTransaction(point, MythRoleEnum.START.getCode(), MythStatusEnum.BEGIN.getCode(), <span class="string">""</span>);</span><br><span class="line">    <span class="comment">// 发布事务保存事件，异步保存</span></span><br><span class="line">    publishEvent.publishEvent(mythTransaction, EventTypeEnum.SAVE.getCode());</span><br><span class="line">    <span class="comment">// 当前事务保存到ThreadLocal</span></span><br><span class="line">    CURRENT.set(mythTransaction);</span><br><span class="line">    <span class="comment">// 设置tcc事务上下文，这个类会传递给远端</span></span><br><span class="line">    MythTransactionContext context = <span class="keyword">new</span> MythTransactionContext();</span><br><span class="line">    <span class="comment">// 设置事务id</span></span><br><span class="line">    context.setTransId(mythTransaction.getTransId());</span><br><span class="line">    <span class="comment">// 设置为发起者角色</span></span><br><span class="line">    context.setRole(MythRoleEnum.START.getCode());</span><br><span class="line">    TransactionContextLocal.getInstance().set(context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MythTransactionEventPublisher.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishEvent</span><span class="params">(<span class="keyword">final</span> MythTransaction mythTransaction, <span class="keyword">final</span> <span class="keyword">int</span> type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> RingBuffer&lt;MythTransactionEvent&gt; ringBuffer = disruptor.getRingBuffer();</span><br><span class="line">    ringBuffer.publishEvent(<span class="keyword">new</span> MythTransactionEventTranslator(type), mythTransaction);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="6"><li>消费者：消费缓存中主动发送给消费端的数据<blockquote><p><a href="http://san-yun.iteye.com/blog/2072726" target="_blank" rel="noopener">executor的execute()和submit方法区别</a></p></blockquote></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MythTransactionEventHandler.</span></span><br><span class="line"><span class="comment"> *  // 事件消费者，也就是一个事件处理器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xiaoyu(Myth)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MythTransactionEventHandler</span> <span class="keyword">implements</span> <span class="title">WorkHandler</span>&lt;<span class="title">MythTransactionEvent</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CoordinatorService coordinatorService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Executor executor;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MythTransactionEventHandler</span><span class="params">(<span class="keyword">final</span> CoordinatorService coordinatorService,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">final</span> Executor executor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.coordinatorService = coordinatorService;</span><br><span class="line">        <span class="keyword">this</span>.executor = executor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据EventTypeEnum事务类型不同处理</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(<span class="keyword">final</span> MythTransactionEvent mythTransactionEvent)</span> </span>&#123;</span><br><span class="line">        executor.execute(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (mythTransactionEvent.getType() == EventTypeEnum.SAVE.getCode()) &#123;</span><br><span class="line">                coordinatorService.save(mythTransactionEvent.getMythTransaction());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mythTransactionEvent.getType() == EventTypeEnum.UPDATE_PARTICIPANT.getCode()) &#123;</span><br><span class="line">                coordinatorService.updateParticipant(mythTransactionEvent.getMythTransaction());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mythTransactionEvent.getType() == EventTypeEnum.UPDATE_STATUS.getCode()) &#123;</span><br><span class="line">                <span class="keyword">final</span> MythTransaction mythTransaction = mythTransactionEvent.getMythTransaction();</span><br><span class="line">                coordinatorService.updateStatus(mythTransaction.getTransId(), mythTransaction.getStatus());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mythTransactionEvent.getType() == EventTypeEnum.UPDATE_FAIR.getCode()) &#123;</span><br><span class="line">                coordinatorService.updateFailTransaction(mythTransactionEvent.getMythTransaction());</span><br><span class="line">            &#125;</span><br><span class="line">            mythTransactionEvent.clear();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Feign源码">2.1.4.3. Feign源码</h4><p><a href="http://techblog.ppdai.com/2018/05/14/20180514/" target="_blank" rel="noopener">feign源码解析</a></p><ul><li>设计模式：建造者模式</li></ul><h3 id="netty系列">2.1.5. netty系列</h3><ol><li><p><a href="https://github.com/waylau/netty-4-user-guide" target="_blank" rel="noopener">Netty 4.x 用户指南(netty-4-user-guide)</a></p></li><li><p><a href="https://github.com/a2888409/face2face" target="_blank" rel="noopener">基于netty的IM服务器(face2face)</a></p></li><li><p><a href="https://github.com/mpusher/mpush" target="_blank" rel="noopener">MPush推送系统(mpush)</a></p></li><li><p><a href="https://github.com/tang-jie/NettyRPC" target="_blank" rel="noopener">基于netty构建RPC系统(NettyRPC)</a></p></li><li><p><a href="https://github.com/YunaiV/netty" target="_blank" rel="noopener">芋艿源码解读(netty)</a></p></li></ol><h1 id="博客大佬">3. 博客大佬</h1><ol><li><a href="https://crossoverjie.top/" target="_blank" rel="noopener">crossoverJie’s Blog</a></li></ol></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/总结/" rel="tag"><i class="fa fa-tag"></i> 总结</a><a href="/tags/面试/" rel="tag"><i class="fa fa-tag"></i> 面试</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/aliyun-learning-summary.html" rel="next" title="阿里云服务器总结"><i class="fa fa-chevron-left"></i> 阿里云服务器总结</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/life-common-software.html" rel="prev" title="好用的软件总结">好用的软件总结<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div id="SOHUCS"></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/uploads/avatar.jpeg" alt="咸鱼翻面"><p class="site-author-name" itemprop="name">咸鱼翻面</p><p class="site-description motion-element" itemprop="description">stay hungry! stay foolish!</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">61</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">13</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">44</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/Hunterfish" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:1574629105@qq.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://www.google.com" target="_blank" title="Google"><i class="fa fa-fw fa-google"></i> Google</a></span><span class="links-of-author-item"><a href="https://gitee.com/ddebug" target="_blank" title="码云"><i class="fa fa-fw fa-globe"></i> 码云</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="http://www.baidu.com" title="李彦宏" target="_blank">李彦宏</a></li><li class="links-of-blogroll-item"><a href="http://taobao.com/" title="马云" target="_blank">马云</a></li></ul></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#github"><span class="nav-text">1. github</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#文档知识"><span class="nav-text">1.1. 文档知识</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#开源项目"><span class="nav-text">1.2. 开源项目</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Java垂直爬虫框架-Web-Magic"><span class="nav-text">1.2.1. Java垂直爬虫框架(Web Magic)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Cloud-Vue-oAuth2-0商城-paascloud-master"><span class="nav-text">1.2.2. Spring Cloud + Vue + oAuth2.0商城(paascloud-master)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#基于可靠消息最终一致性分布式事务框架-myth"><span class="nav-text">1.2.3. 基于可靠消息最终一致性分布式事务框架(myth)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#高性能异步分布式事务TCC框架"><span class="nav-text">1.2.4. 高性能异步分布式事务TCC框架</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#开源项目讲解"><span class="nav-text">2. 开源项目讲解</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Hmily项目demo流程"><span class="nav-text">2.1. Hmily项目demo流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用技术"><span class="nav-text">2.1.1. 使用技术</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#mysql乐观锁"><span class="nav-text">2.1.1.1. mysql乐观锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ScheduledExecutorService"><span class="nav-text">2.1.1.2. ScheduledExecutorService</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#切面-AOP"><span class="nav-text">2.1.1.3. 切面-AOP</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tcc库作用"><span class="nav-text">2.1.2. tcc库作用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#执行confirm、cancel方法失败时"><span class="nav-text">2.1.3. 执行confirm、cancel方法失败时</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Myth项目demo流程"><span class="nav-text">2.1.4. Myth项目demo流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#订单支付流程异常处理"><span class="nav-text">2.1.4.1. 订单支付流程异常处理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#停掉Invertory库存服务"><span class="nav-text">2.1.4.1.1. 停掉Invertory库存服务</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#停掉Order服务"><span class="nav-text">2.1.4.1.2. 停掉Order服务</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#停掉消息服务RabbitMQ"><span class="nav-text">2.1.4.1.3. 停掉消息服务RabbitMQ</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Disruptor-无锁并行计算框架"><span class="nav-text">2.1.4.2. Disruptor(无锁并行计算框架)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Feign源码"><span class="nav-text">2.1.4.3. Feign源码</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#netty系列"><span class="nav-text">2.1.5. netty系列</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#博客大佬"><span class="nav-text">3. 博客大佬</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2018</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">咸鱼翻面</span> <span class="post-meta-divider">|</span> <span>Hosted by <a href="https://pages.coding.me" style="font-weight:700">Coding Pages</a></span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script src="/js/src/utils.js?v=5.1.4"></script><script src="/js/src/motion.js?v=5.1.4"></script><script src="/js/src/affix.js?v=5.1.4"></script><script src="/js/src/schemes/pisces.js?v=5.1.4"></script><script src="/js/src/scrollspy.js?v=5.1.4"></script><script src="/js/src/post-details.js?v=5.1.4"></script><script src="/js/src/bootstrap.js?v=5.1.4"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>!function(){var t,e,n,a,c="cytBatcJ1",o="21816cae9b6cf06d7d970433e6499961";if((window.innerWidth||document.documentElement.clientWidth)<960)window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id='+c+"&conf="+o+'"><\/script>');else{t="https://changyan.sohu.com/upload/changyan.js",e=function(){window.changyan.api.config({appid:c,conf:o})},n=document.getElementsByTagName("head")[0]||document.head||document.documentElement,(a=document.createElement("script")).setAttribute("type","text/javascript"),a.setAttribute("charset","UTF-8"),a.setAttribute("src",t),"function"==typeof e&&(window.attachEvent?a.onreadystatechange=function(){var t=a.readyState;"loaded"!==t&&"complete"!==t||(a.onreadystatechange=null,e())}:a.onload=e),n.appendChild(a)}}()</script><script src="https://assets.changyan.sohu.com/upload/plugins/plugins.count.js"></script><script>// Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });</script><script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script><script>AV.initialize("lg7TJ27LGJdRgK9EwdLFvLk0-gzGzoHsz","86IjysDufJSLn0blFJMdAu2O")</script><script>function showTime(e){var t=new AV.Query(e),c=[],u=$(".leancloud_visitors");u.each(function(){c.push($(this).attr("id").trim())}),t.containedIn("url",c),t.find().done(function(e){var t=".leancloud-visitors-count";if(0!==e.length){for(var n=0;n<e.length;n++){var o=e[n],i=o.get("url"),s=o.get("time"),r=document.getElementById(i);$(r).find(t).text(s)}for(n=0;n<c.length;n++){i=c[n],r=document.getElementById(i);var l=$(r).find(t);""==l.text()&&l.text(0)}}else u.find(t).text(0)}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(i){var e=$(".leancloud_visitors"),s=e.attr("id").trim(),r=e.attr("data-flag-title").trim(),t=new AV.Query(i);t.equalTo("url",s),t.find({success:function(e){if(0<e.length){var t=e[0];t.fetchWhenSave(!0),t.increment("time"),t.save(null,{success:function(e){$(document.getElementById(s)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else{var n=new i,o=new AV.ACL;o.setPublicReadAccess(!0),o.setPublicWriteAccess(!0),n.setACL(o),n.set("title",r),n.set("url",s),n.set("time",1),n.save(null,{success:function(e){$(document.getElementById(s)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to create")}})}},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):1<$(".post-title-link").length&&showTime(e)})</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script></body></html>