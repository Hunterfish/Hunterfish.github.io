---
title: 使用RabbitMQ实现服务间异步消息调用
date: 2018-05-30 13:20:34
categories: Spring Cloud微服务实战
tags:
  - Spring Boot
  - RabbitMQ
---
# 同步 or 异步   

多模块化后的**order**订单服务和**product**商品服务之间的通信是同步的，订单会调用商品的扣库存远程服务。  

## 分析  

1. 用户服务  

![](http://p8hqd7oln.bkt.clouddn.com/18-5-30/10741821.jpg)

> **用户服务**在用户登录时，会调用**短信服务**给用户发短信；登录操作可能会调用**积分服务**给用户加积分；等等调用其他服务。  

> 如果上面都采用同步通信机制，服务之间耦合过大，用户登录过程需要多个服务同时响应成功才能成功，造成不好的用户体验；  

> 我们可以通过消息队列解决上面问题。  

2. 本项目订单/商品服务  

![](http://p8hqd7oln.bkt.clouddn.com/18-5-30/23312725.jpg)

> **订单服务**在扣库存前先调用**商品服务**查询商品信息接口，之后再调用减库存接口进行减库存操作；  

> 如果我们改造成：**商品服务**在更改库存后发布消息【库存变化】，**订单服务**订阅此消息，获取商品的具体信息，比如可购买商品的个数、商品ID等； 
**订单服务**在下单时，不会去**商品服务**调用查询商品信息接口，而是在本服务中查询了；  

> 然后**订单服务**在扣库存时，发布消息【扣库存】，**商品服务**订阅此消息，读取消息后，减少对应商品的库存量；  

> 支付成功/失败也会对库存有影响：具体看业务设计，比如设置30分钟后如果未支付，由**支付服务**发布消息，**商品服务**和**订单服务**同时订阅此消息， 
就能够保证数据的最终一致性。  

> 再通俗讲，比如**用户服务**购买商品后，业务上还要给用户加积分，发短信，此时，**订单服务**不需要修改，**短信服务**和**积分服务**只要也订阅了消息， 
相应的积分、短信就可以实现。 

## 消息中间件的选择  

* **RabbitMQ**  
* **Kafka**  
* **ActiveMQ**   

# 订单/商品同步改为异步消息调用  

