---
title: Spring Cloud 实战 (三)：微信点餐业务服务拆分
date: 2018-05-14 10:49:31
categories: Spring Cloud微服务实战
tags:
  - Spring Cloud
  - Eureka
---

# 点餐业务服务拆分  

## 服务拆分方式  

### 第一种  
![](http://p8hqd7oln.bkt.clouddn.com/18-5-14/2485616.jpg)
* 手机端（买家端）  
> 基于Node.js的Vue买家端appUI放到nginx里，作为一个边缘服务  

* PC端（卖家端）  
> 基于Freemarker的网页传统CMS管理中心，作为另外一个边缘服务  

### 第二种  

> 按照业务划分  
![](http://p8hqd7oln.bkt.clouddn.com/18-5-14/13179126.jpg)

### 点餐项目拆分  

1. 上面两种方式都不合适  
> 如果点餐项目自己的小店，Boss是我，开发是我，运维是我，自己上线；如果微服务拆分，反而没必要，增加部署难度；  
> 如果属于IT公司的点餐项目，服务增长迅速，具有充足的前后端开发人员，可以依据业务分成小组，一个小组对应一个微服务；  

## 服务拆分方法论  

### 扩展立方模型（Scale Cube）  
![](http://p8hqd7oln.bkt.clouddn.com/18-5-14/95279509.jpg)
* X轴 —— 水平复制  
> 通过副本扩展，将应用程序水平复制，通过负载均衡运行多个完全就一样的副本的方式，来实现应用程序的伸缩性，提高应用程序的容量和可用度；  

* Z轴 —— 数据分区  
> 每个服务器负责一个数据子集，每个服务器运行的代码是一样的；  

* Y轴 —— 功能解耦  
> 将不同的职责模块分成不同的功能服务  

### 如何拆分数据  

* 每个微服务都有单独的数据存储  
> 微服务间共享一个数据存储，将紧密耦合。比如更改一个微服务中的数据库的表结构，可能导致另外一个微服务出现问题。  
> 拥有自己的数据库后，要避免访问别的服务的数据库；  
> 一个服务所拥有的数据，只能通过这个服务提供的API接口来访问，服务之间都是有隔离的；  

* 依据服务特点选择不同结构的数据库类型  
> 比如node.js开发的前置服务，主要是展示类型的数据，类型丰富，对事务要求不高，可以考虑使用NoSql的Mongo数据库；  
> 比如专门做搜索类型的服务，可以考虑使用**Elasticsearch**即ES这样的存储；  
> 对事务要求较高的比如订单、商品等，优先考虑支持事务的关系型数据库如**MySQL**;  

* 针对边界设计API（视频教程4-12未完待续补充）  
> 比如用户服务，拥有自己的数据库，包含了完整的用户信息：密码、用户名、状态、登陆时间、注册时间等； 
对内部的其他服务暴露API接口，其他服务可以通过接口的方式查询自己关心的用户信息；支付服务关心用户的状态(是否被锁定，是否被冻结，用户的渠道等等)；积分的服务关心用户的注册操作时间等；

### 如何拆分功能  

* **单一职责，松耦合、高内聚**  
> 单一职责：每个服务只负责业务功能中一个单独的部分；  
> 松耦合：服务之间耦合度低，修改一个服务不会导致另外一个服务修改；  
> 高内聚：服务内部相关的服务都聚在一个服务之中，而不是分散在不同的服务之中；  

* **关注点分离**  
> 按职责：给我们的服务进行分类。比如按业务领域划分的服务，职责比较单一，比如订单、支付、商品等等；  
> 按通用性：与业务无关的基础的通用的组件。比如消息服务、用户服务；  
> 按粒度级别：微服务的粒度不是越小越好，根据业务的发展、规模具体分析。  

### 服务和数据的关系  

#### 先考虑业务功能，再考虑数据  

#### 无状态服务  

> 状态：如果一个数据需要被多个服务共享，才能完成一个请求，就可以成为状态；  
> 依赖这个状态的服务称为有状态服务；  
> 微服务中并不是说不允许存在有状态服务，而是把有状态的服务改变为无状态的服务。  

![](http://p8hqd7oln.bkt.clouddn.com/18-5-14/67053361.jpg)

> 比如上图显示的以前学习的点餐系统在本地内存中建立的数据缓存--session缓存，在现在的微服务架构中，迁移到分布式缓存中；  
> 让业务服务变成一个无状态的计算节点；
> 迁移后，后端业务服务就可以按需动态伸缩，在运行时动态增删节点，不用再考虑缓存数据如何同步的问题。  

## 点餐业务服务拆分分析  

![](http://p8hqd7oln.bkt.clouddn.com/18-5-14/31223826.jpg)







